name: Working APK Build

on:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-dev \
          git \
          zip \
          unzip \
          openjdk-11-jdk
        
    - name: Install Buildozer
      run: |
        pip3 install buildozer cython
        
    - name: Verify project structure
      run: |
        echo "=== Project files ==="
        ls -la
        
        echo -e "\n=== Creating minimal files if missing ==="
        if [ ! -f "main.py" ]; then
          echo "Creating main.py..."
          cat > main.py << 'EOF'
from kivy.app import App
from kivy.uix.label import Label

class TestApp(App):
    def build(self):
        return Label(text='Hello World!')

if __name__ == '__main__':
    TestApp().run()
EOF
        fi
        
        if [ ! -f "buildozer.spec" ]; then
          echo "Creating buildozer.spec..."
          cat > buildozer.spec << 'EOF'
[app]
title = My App
package.name = myapp
package.domain = org.test
source.dir = .
source.main = main.py
version = 1.0.0
requirements = python3,kivy==2.2.1
orientation = portrait
android.api = 31
android.minapi = 21
android.archs = arm64-v8a
android.accept_sdk_license = True
EOF
        fi
        
    - name: Build APK
      run: |
        echo "=== Starting build ==="
        buildozer android debug
        
        echo -e "\n=== Build result ==="
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ SUCCESS: APK built!"
          ls -lh bin/*.apk
        else
          echo "❌ FAILED: No APK found"
          echo "Checking .buildozer directory..."
          find .buildozer -name "*.apk" 2>/dev/null || echo "No APK in .buildozer"
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: my-app
        path: bin/*.apk
