name: Build APK with Docker (Guaranteed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-with-docker:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build with pre-configured Docker
      run: |
        # استفاده از Docker image از پیش پیکربندی شده
        docker run --rm \
          -v $(pwd):/src \
          -v buildozer_cache:/home/user/.buildozer \
          jachin007/buildozer:latest \
          bash -c "
          cd /src && \
          echo '=== Starting Buildozer ===' && \
          buildozer android clean 2>&1 && \
          buildozer -v android debug 2>&1 | tail -100
          "
          
    - name: Check for APK files
      run: |
        echo "Looking for APK files..."
        find . -name "*.apk" -type f | head -10 || echo "No APK files found"
        
        if ls bin/*.apk 2>/dev/null; then
          echo "✅ APK found!"
          ls -lh bin/*.apk
        else
          echo "❌ No APK in bin/"
          echo "Searching everywhere..."
          find . -type f -name "*.apk" 2>/dev/null || echo "No APK files anywhere"
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error        path: debug.log
        retention-days: 7
        
    - name: Upload APK if exists
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: apk-file
        path: bin/
        retention-days: 7
